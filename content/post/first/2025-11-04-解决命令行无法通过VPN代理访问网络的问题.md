+++
title = '解决命令行无法通过VPN代理访问网络的问题!'
date = 2025-11-03T10:55:00
draft = false
categories = ["工具", "Windows"]
tags = ["VPN", "代理", "PowerShell"]
+++
# 解决在Windows上命令行无法通过VPN代理访问网络的问题

## 问题描述

当VPN开启时，网页浏览器可以正常访问Google等网站，但在命令行（CMD）或PowerShell中，`ping`、`curl` 等工具无法访问这些网站，通常表现为连接超时。

这通常是因为VPN客户端默认只代理了浏览器或特定应用的流量（分裂隧道模式），而没有为整个系统或命令行环境设置全局代理。

## 解决步骤

### 1. 初步诊断

首先，我们确认问题确实存在于命令行环境中。

*   **测试外部连接 (Google):**
    ```bash
    ping google.com
    # 结果: 100%丢包，请求超时
    ```
*   **测试内部连接 (Baidu):**
    ```bash
    ping baidu.com
    # 结果: 成功接收数据，延迟正常
    ```
*   **结论:** 网络本身是通的，但命令行无法访问被限制的网站，问题指向代理设置。

### 2. 检查系统代理设置

我们检查Windows系统级别的代理设置，看是否有为命令行工具配置代理。

*   **使用 `netsh` 命令检查:**
    ```bash
    netsh winhttp show proxy
    ```
*   **���型的问题输出:**
    ```
    当前的 WinHTTP 代理服务器设置:

        直接访问(没有代理服务器)。
    ```
*   **结论:** 系统并未配置全局代理，这解释了为什么命令行工具无法通过VPN。

### 3. 寻找并测试VPN代理

多数VPN客户端会在本地启动一个HTTP或SOCKS5代理服务。我们需要找到这个服务的地址和端口，并进行测试。

*   **常见的本地代理地址:** `127.0.0.1` (或 `localhost`)
*   **常见的代理端口:** `7890`, `1080`, `10809`, `8888` 等 (具体请在您的VPN客户端设置中查找)。

我们使用 `curl` 命令直接指定代理进行测试，这是最关键的一步。假设通过VPN客户端查到代理是SOCKS5类型，地址是 `127.0.0.1:7890`。

*   **使用 `curl` 指定SOCKS5代理进行测试:**
    ```bash
    curl -v --socks5 127.0.0.1:7890 https://www.google.com
    ```
*   **成功的标志:**
    您会看到 `* SOCKS5 request granted.` 和 `* Connected to 127.0.0.1 ...` 等信息，最后是Google服务器返回的HTTP响应（例如 `HTTP/1.1 301 Moved Permanently` 或 `HTTP/2 200`）。

*   **结论:** 这证明了代理服务是正常的，我们只需要让所有命令行工具都使用它。

### 4. 配置环境变量 (最终解决方案)

为了让所有命令行工具自动使用这个SOCKS5代理��我们需要设置一个标准的环境变量。`ALL_PROXY` 是一个被广泛支持的变量。

#### 临时设置 (只在当前窗口有效)

*   **在 PowerShell 中:**
    ```powershell
    $env:ALL_PROXY="socks5://127.0.0.1:7890"
    $env:HTTP_PROXY="socks5://127.0.0.1:7890"
    $env:HTTPS_PROXY="socks5://127.0.0.1:7890"
# 设置环境变量
$env:HTTP_PROXY = "http://127.0.0.1:7890"
$env:HTTPS_PROXY = "http://127.0.0.1:7890"
# 或者使用 netsh 命令设置系统代理
netsh winhttp set proxy proxy-server:port
    ```
*   **在 CMD 中:**
    ```cmd
    set ALL_PROXY=socks5://127.0.0.1:7890
    set HTTP_PROXY=http://127.0.0.1:7890
    set HTTPS_PROXY=http://127.0.0.1:7890
    ```
    **注意:** `socks5://` 这个前缀至关重要。

#### 永久设置 (所有新开的终端都有效)

要让这个设置永久生效，需要将其添加到Windows的系统环境变量中。

1.  按 `Win` 键，搜索“编辑系统环境变量”并打开它。
2.  在“高级”选项卡下，点击“环境变量...”按钮。
3.  在“用户变量”或“系统变量”区域，点击“新建...”。
    *   **变量名:** `ALL_PROXY`
    *   **变量值:** `socks5://127.0.0.1:7890`
4.  点击“确定”保存所有窗口。
5.  **重启**所有已打开的命令行窗口，新的设置将会生效。